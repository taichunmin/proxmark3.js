!function(a,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash")):"function"==typeof define&&define.amd?define(["lodash"],t):(a="undefined"!=typeof globalThis?globalThis:a||self).Pm3Waveshare=t(a._)}(this,(function(a){"use strict";function t(a){return a&&"object"==typeof a&&"default"in a?a:{default:a}}var e=t(a);const i=["FSTN10m","WSDZ10m"],n={M2in13:{id:4,type:"M2in13",proto:1,name:"2.13 inch NFCTag",len:16,width:122,height:250},M2in9:{id:9,type:"M2in9",proto:1,name:"2.9  inch e-paper",len:16,width:296,height:128},M4in2:{id:10,type:"M4in2",proto:1,name:"4.2  inch e-paper",len:100,width:400,height:300},M7in5:{id:14,type:"M7in5",proto:1,name:"7.5  inch e-paper",len:120,width:800,height:480},M2in7:{id:16,type:"M2in7",proto:2,name:"2.7  inch e-paper",len:121,width:176,height:276},M2in13B:{id:11,type:"M2in13B",proto:2,name:"2.13 inch e-paper B (with red)",len:106,width:104,height:212},M1in54B:{id:0,type:"M1in54B",proto:3,name:"1.54 inch e-paper B (with red)",len:100,width:200,height:200},M7in5HD:{id:17,type:"M7in5HD",proto:1,name:"7.5  inch e-paper HD",len:120,width:880,height:528}};return class{constructor(){this.name="waveshare"}install(a,t){const{CMD:r,Packet:c,pm3:d,utils:{logTime:w,retry:s,sleep:o}}=a,p=async({ack:a=null,cmd:t,data:i=new c,retryDelay:n=0,times:w=10})=>{await s((async()=>{try{await(async({ack:a=null,cmd:t,data:i=new c})=>{if(!c.isLen(i))throw new TypeError("invalid data type");const n=c.merge(new c([205,t]),i);await d.sendCommandMix({cmd:r.HF_ISO14443A_READER,arg:[683,n.length],data:n});const w=await d.waitRespTimeout(r.ACK),s=w.data.subarray(0,Number(w.getArg(0)));if(e.default.isInteger(a)){if(s.length<2)throw new Error("invalid response length");if(s.getUint16(0,!1)!==a)throw new Error("invalid response ack")}})({ack:a,cmd:t,data:i})}catch(a){throw await o(n),a}}),w)};return{MODEL:n,draw_1in54B:async({black:a,red:t})=>{try{if(!c.isLen(a,5e3))throw new TypeError("invalid black");if(!c.isLen(t,5e3))throw new TypeError("invalid red");await s((async()=>{try{const{card:a}=await d.$hf14a.selectCard();if(!e.default.includes(i,a?.uid?.utf8))throw new Error("invalid waveshare NFCTag")}catch(a){throw await o(100),a}}),10),w("step0: 0xCD0D"),await p({cmd:13,ack:0}),await o(20),w("step1: 0xCD00"),await p({cmd:0,ack:0}),await o(20),w("step2: 0xCD01"),await p({cmd:1,ack:0}),await o(200),w("step3: 0xCD02"),await p({cmd:2,ack:0}),await o(100),w("step4: 0xCD03"),await p({cmd:3,ack:0}),await o(100),w("step5: 0xCD05 with black data");const n=c.merge(new c([100]),new c(100));for(let t=0;t<50;t++)n.set(a.subarray(100*t,100*(t+1)),1),await p({cmd:5,data:n,ack:0});w("step6: 0xCD04"),await p({cmd:4,ack:0}),w("step7: 0xCD05 with red data");for(let a=0;a<50;a++)n.set(t.subarray(100*a,100*(a+1)),1),await p({cmd:5,data:n,ack:0}),await o(20);w("step8: 0xCD06"),await p({cmd:6,ack:0}),await o(1e3),w("step9: 0xCD08"),await p({cmd:8,ack:65280,retryDelay:100,times:100}),await o(20),w("step10: 0xCD04"),await p({cmd:4,ack:0})}finally{await d.$hf14a.dropField()}},async drawV1({model:a,black:t}){try{if(1!==(a=n[a])?.proto)throw new TypeError("invalid model");if(!c.isLen(t,a.width*a.height/8))throw new TypeError("invalid black type");await s((async()=>{try{const{card:a}=await d.$hf14a.selectCard();if(!e.default.includes(i,a?.uid?.utf8))throw new Error("invalid waveshare NFCTag")}catch(a){throw await o(100),a}}),10),w("step0: 0xCD0D"),await p({cmd:13,ack:0}),w("step1: 0xCD00"),await p({cmd:0,data:new c([a.id]),ack:0}),await o(100),w("step2: 0xCD01"),await p({cmd:1,ack:0}),await o(10),w("step3: 0xCD02"),await p({cmd:2,ack:0}),await o(10),w("step4: 0xCD03"),await p({cmd:3,ack:0}),await o(10),w("step5: 0xCD05"),await p({cmd:5,ack:0}),await o(10),w("step6: 0xCD06"),await p({cmd:6,ack:0}),await o(10),w("step7: 0xCD07"),await p({cmd:7,ack:0}),w("step8: 0xCD08 with black data");const r=c.merge(new c([a.len]),new c(a.len));for(const e of t.chunk(a.len))r.set(e,1),await p({cmd:8,data:r,ack:0});w("step10: 0xCD09"),await p({cmd:9,ack:0}),await o(200+("M7in5HD"===a.type?1e3:0)),w("step11: 0xCD0A"),await p({cmd:10,ack:65280,retryDelay:25,times:100}),await o(10),w("step10: 0xCD04"),await p({cmd:4,ack:0})}finally{await d.$hf14a.dropField()}}}}}}));
