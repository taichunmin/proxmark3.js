!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("lodash")):"function"==typeof define&&define.amd?define(["exports","lodash"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Proxmark3={},t._)}(this,(function(t,e){"use strict";function _(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=_(e);class n extends Uint8Array{constructor(...t){super(...t),this.dv=new DataView(this.buffer,this.byteOffset,this.length)}static fromView(t){if(!ArrayBuffer.isView(t))throw new TypeError("invalid view");return new n(t.buffer,t.byteOffset,t.byteLength)}static fromHex(t,e=!1){const _=t.replace(/[^0-9A-Fa-f]/g,"").match(/.{2}/g);return e&&_.reverse(),new n(r.default.map(_,(t=>r.default.parseInt(t,16))))}static fromUtf8(t){return n.fromView((new TextEncoder).encode(t))}static merge(...t){if(t.length<2)return t.length?t[0]:new n;const e=r.default.sumBy(t,"length"),_=new n(e);return r.default.reduce(t,((t,e)=>(_.set(e,t),t+e.length)),0),_}static isLen(t,e=null){return t instanceof n&&(r.default.isNil(e)||t.length===e)}isEqual(t){return this.length===t.length&&this.every(((e,_)=>e===t[_]))}chunk(t){if(t<1)throw new TypeError("invalid bytesPerChunk");const e=[];for(let _=0;_<this.length;_+=t)e.push(this.subarray(_,_+t));return e}get hex(){return r.default.map(this,(t=>(t+256).toString(16).slice(-2))).join("").toUpperCase()}get rhex(){return r.default.map(this,(t=>(t+256).toString(16).slice(-2))).reverse().join("").toUpperCase()}get inspect(){return`${r.default.map(this,(t=>(t+256).toString(16).slice(-2))).join(" ").toUpperCase()} (len=${this.length})`}get utf8(){return(new TextDecoder).decode(this)}get base64url(){const t=[];for(let e=0;e<this.length;e+=3){let _=0;for(let t=0;t<3;t++)_|=(e+t<this.length?this[e+t]:0)<<16-8*t;t.push(r.default.times(Math.min(this.length-e+1,4),(t=>"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"[_>>18-6*t&63])).join(""))}return t.join("")}dvGetter(t,e,_=!0){return e<0&&(e+=this.dv.byteLength),this.dv[t](e,_)}getBigInt64(...t){return this.dvGetter("getBigInt64",...t)}getBigUint64(...t){return this.dvGetter("getBigUint64",...t)}getFloat32(...t){return this.dvGetter("getFloat32",...t)}getFloat64(...t){return this.dvGetter("getFloat64",...t)}getInt16(...t){return this.dvGetter("getInt16",...t)}getInt32(...t){return this.dvGetter("getInt32",...t)}getInt8(...t){return this.dvGetter("getInt8",...t)}getUint16(...t){return this.dvGetter("getUint16",...t)}getUint32(...t){return this.dvGetter("getUint32",...t)}getUint8(...t){return this.dvGetter("getUint8",...t)}dvSetter(t,e,_,r=!0){return e<0&&(e+=this.dv.byteLength),this.dv[t](e,_,r),this}setBigInt64(...t){return this.dvSetter("setBigInt64",...t)}setBigUint64(...t){return this.dvSetter("setBigUint64",...t)}setFloat32(...t){return this.dvSetter("setFloat32",...t)}setFloat64(...t){return this.dvSetter("setFloat64",...t)}setInt16(...t){return this.dvSetter("setInt16",...t)}setInt32(...t){return this.dvSetter("setInt32",...t)}setInt8(...t){return this.dvSetter("setInt8",...t)}setUint16(...t){return this.dvSetter("setUint16",...t)}setUint32(...t){return this.dvSetter("setUint32",...t)}setUint8(...t){return this.dvSetter("setUint8",...t)}getUint24(t,e=!0){const[_,r]=e?[t+2,t]:[t,t+1];return this.getUint8(_)<<16|this.getUint16(r,e)}setUint24(t,e,_=!0){const[r,n]=_?[t+2,t]:[t,t+1];return this.setUint8(r,e>>16&255),this.setUint16(n,65535&e,_),this}getInt24(t,e=!0){const _=this.getUint24(t,e);return _-(_>8388607?16777216:0)}setInt24(t,e,_=!0){return this.setUint24(t,16777215&e,_)}}const i=(...t)=>console.log(`[${(new Date).toTimeString().slice(0,8)}]`,...t),F=t=>new Promise((e=>setTimeout(e,t)));class E extends Error{constructor(t){if(!(t instanceof Error))throw new TypeError("invalid err type");super(t.message),this.name=this.constructor.name,this.originalError=t,this.stack=`${this.stack}\n${t.stack}`}}const s=t=>{if(!r.default.isArray(t))throw new TypeError("Middleware stack must be an array!");if(r.default.some(t,(t=>!r.default.isFunction(t))))throw new TypeError("Middleware must be composed of functions!");return async(e={},_)=>{const n=[...t,...r.default.isFunction(_)?[_]:[]],i=r.default.times(n.length+1,(()=>0)),F=async t=>{if(0!==i[t])throw new Error(`middleware[${t}] called multiple times`);if(t>=n.length)i[t]=2;else try{i[t]=1;const _=await n[t](e,(()=>F(t+1)));if(1===i[t+1])throw new Error(`next() in middleware[${t}] should be awaited`);return i[t]=2,_}catch(e){throw i[t]=3,e.stack&&(e.stack=e.stack.replace(/at async dispatch[^\n]+\n[^\n]+\n\s*/g,"")),e}};return await F(0)}};var I=Object.freeze({__proto__:null,logTime:i,sleep:F,RethrownError:E,retry:async(t,e=3)=>{if(e<1)throw new TypeError("invalid times");let _=null;for(;e--;)try{return await t()}catch(t){_=t}throw new E(_)},middlewareCompose:s});const a=r.default.fromPairs(r.default.map([[0,"DEVICE_INFO"],[1,"SETUP_WRITE"],[3,"FINISH_WRITE"],[4,"HARDWARE_RESET"],[5,"START_FLASH"],[6,"CHIP_INFO"],[7,"BL_VERSION"],[254,"NACK"],[255,"ACK"],[256,"DEBUG_PRINT_STRING"],[257,"DEBUG_PRINT_INTEGERS"],[258,"DEBUG_PRINT_BYTES"],[259,"LCD_RESET"],[260,"LCD"],[261,"BUFF_CLEAR"],[262,"READ_MEM"],[263,"VERSION"],[264,"STATUS"],[265,"PING"],[272,"DOWNLOAD_EML_BIGBUF"],[273,"DOWNLOADED_EML_BIGBUF"],[274,"CAPABILITIES"],[275,"QUIT_SESSION"],[276,"SET_DBGMODE"],[277,"STANDALONE"],[278,"WTX"],[279,"TIA"],[280,"BREAK_LOOP"],[281,"SET_TEAROFF"],[288,"GET_DBGMODE"],[289,"FLASHMEM_WRITE"],[290,"FLASHMEM_WIPE"],[291,"FLASHMEM_DOWNLOAD"],[292,"FLASHMEM_DOWNLOADED"],[293,"FLASHMEM_INFO"],[294,"FLASHMEM_SET_SPIBAUDRATE"],[304,"SPIFFS_MOUNT"],[305,"SPIFFS_UNMOUNT"],[306,"SPIFFS_WRITE"],[4402,"SPIFFS_APPEND"],[307,"SPIFFS_READ"],[308,"SPIFFS_REMOVE"],[308,"SPIFFS_RM"],[309,"SPIFFS_RENAME"],[309,"SPIFFS_MV"],[310,"SPIFFS_COPY"],[310,"SPIFFS_CP"],[311,"SPIFFS_STAT"],[312,"SPIFFS_FSTAT"],[313,"SPIFFS_INFO"],[290,"SPIFFS_FORMAT"],[314,"SPIFFS_WIPE"],[8496,"SPIFFS_PRINT_TREE"],[8497,"SPIFFS_GET_TREE"],[8498,"SPIFFS_TEST"],[8499,"SPIFFS_PRINT_FSINFO"],[8500,"SPIFFS_DOWNLOAD"],[8501,"SPIFFS_DOWNLOADED"],[12288,"SPIFFS_CHECK"],[320,"SMART_RAW"],[321,"SMART_UPGRADE"],[322,"SMART_UPLOAD"],[323,"SMART_ATR"],[324,"SMART_SETBAUD"],[325,"SMART_SETCLOCK"],[352,"USART_RX"],[353,"USART_TX"],[354,"USART_TXRX"],[355,"USART_CONFIG"],[514,"LF_TI_READ"],[515,"LF_TI_WRITE"],[517,"LF_ACQ_RAW_ADC"],[518,"LF_MOD_THEN_ACQ_RAW_ADC"],[519,"DOWNLOAD_BIGBUF"],[520,"DOWNLOADED_BIGBUF"],[521,"LF_UPLOAD_SIM_SAMPLES"],[522,"LF_SIMULATE"],[523,"LF_HID_WATCH"],[524,"LF_HID_SIMULATE"],[525,"LF_SET_DIVISOR"],[526,"LF_SIMULATE_BIDIR"],[527,"SET_ADC_MUX"],[528,"LF_HID_CLONE"],[529,"LF_EM410X_CLONE"],[532,"LF_T55XX_READBL"],[533,"LF_T55XX_WRITEBL"],[534,"LF_T55XX_RESET_READ"],[535,"LF_PCF7931_READ"],[547,"LF_PCF7931_WRITE"],[553,"LF_EM4X_LOGIN"],[536,"LF_EM4X_READWORD"],[537,"LF_EM4X_WRITEWORD"],[539,"LF_EM4X_PROTECTWORD"],[554,"LF_EM4X_BF"],[538,"LF_IO_WATCH"],[540,"LF_EM410X_WATCH"],[576,"LF_EM4X50_INFO"],[577,"LF_EM4X50_WRITE"],[578,"LF_EM4X50_WRITEPWD"],[579,"LF_EM4X50_READ"],[581,"LF_EM4X50_BRUTE"],[582,"LF_EM4X50_LOGIN"],[592,"LF_EM4X50_SIM"],[593,"LF_EM4X50_READER"],[594,"LF_EM4X50_ESET"],[595,"LF_EM4X50_CHK"],[608,"LF_EM4X70_INFO"],[609,"LF_EM4X70_WRITE"],[610,"LF_EM4X70_UNLOCK"],[611,"LF_EM4X70_AUTH"],[612,"LF_EM4X70_WRITEPIN"],[613,"LF_EM4X70_WRITEKEY"],[541,"LF_SAMPLING_SET_CONFIG"],[542,"LF_FSK_SIMULATE"],[543,"LF_ASK_SIMULATE"],[544,"LF_PSK_SIMULATE"],[562,"LF_NRZ_SIMULATE"],[545,"LF_AWID_WATCH"],[546,"LF_VIKING_CLONE"],[548,"LF_T55XX_WAKEUP"],[549,"LF_COTAG_READ"],[550,"LF_T55XX_SET_CONFIG"],[551,"LF_SAMPLING_PRINT_CONFIG"],[552,"LF_SAMPLING_GET_CONFIG"],[560,"LF_T55XX_CHK_PWDS"],[561,"LF_T55XX_DANGERRAW"],[624,"LF_ZX_READ"],[625,"LF_ZX_WRITE"],[768,"HF_ISO15693_ACQ_RAW_ADC"],[771,"HF_SRI_READ"],[773,"HF_ISO14443B_COMMAND"],[784,"HF_ISO15693_READER"],[785,"HF_ISO15693_SIMULATE"],[786,"HF_ISO15693_SNIFF"],[787,"HF_ISO15693_COMMAND"],[789,"HF_ISO15693_FINDAFI"],[790,"HF_ISO15693_CSETUID"],[791,"HF_ISO15693_SLIX_L_DISABLE_PRIVACY"],[792,"HF_ISO15693_SLIX_L_DISABLE_AESAFI"],[864,"LF_SNIFF_RAW_ADC"],[880,"LF_HITAG_SNIFF"],[881,"LF_HITAG_SIMULATE"],[882,"LF_HITAG_READER"],[871,"LF_HITAGS_TEST_TRACES"],[872,"LF_HITAGS_SIMULATE"],[883,"LF_HITAGS_READ"],[885,"LF_HITAGS_WRITE"],[886,"LF_HITAG_ELOAD"],[896,"HF_ISO14443A_ANTIFUZZ"],[897,"HF_ISO14443B_SIMULATE"],[898,"HF_ISO14443B_SNIFF"],[899,"HF_ISO14443A_SNIFF"],[900,"HF_ISO14443A_SIMULATE"],[901,"HF_ISO14443A_READER"],[903,"HF_LEGIC_SIMULATE"],[904,"HF_LEGIC_READER"],[905,"HF_LEGIC_WRITER"],[906,"HF_EPA_COLLECT_NONCE"],[907,"HF_EPA_REPLAY"],[956,"HF_LEGIC_INFO"],[957,"HF_LEGIC_ESET"],[911,"HF_ICLASS_READCHECK"],[913,"HF_ICLASS_DUMP"],[914,"HF_ICLASS_SNIFF"],[915,"HF_ICLASS_SIMULATE"],[916,"HF_ICLASS_READER"],[918,"HF_ICLASS_READBL"],[919,"HF_ICLASS_WRITEBL"],[920,"HF_ICLASS_EML_MEMSET"],[922,"HF_ICLASS_CHKKEYS"],[923,"HF_ICLASS_RESTORE"],[928,"HF_FELICA_SIMULATE"],[929,"HF_FELICA_SNIFF"],[930,"HF_FELICA_COMMAND"],[938,"HF_FELICALITE_DUMP"],[939,"HF_FELICALITE_SIMULATE"],[944,"HF_ISO14443A_PRINT_CONFIG"],[945,"HF_ISO14443A_GET_CONFIG"],[946,"HF_ISO14443A_SET_CONFIG"],[1024,"MEASURE_ANTENNA_TUNING"],[1025,"MEASURE_ANTENNA_TUNING_HF"],[1026,"MEASURE_ANTENNA_TUNING_LF"],[1056,"LISTEN_READER_FIELD"],[1072,"HF_DROPFIELD"],[1280,"FPGA_MAJOR_MODE_OFF"],[1537,"HF_MIFARE_EML_MEMCLR"],[1538,"HF_MIFARE_EML_MEMSET"],[1539,"HF_MIFARE_EML_MEMGET"],[1540,"HF_MIFARE_EML_LOAD"],[1541,"HF_MIFARE_CSETBL"],[1542,"HF_MIFARE_CGETBL"],[1543,"HF_MIFARE_CIDENT"],[1552,"HF_MIFARE_SIMULATE"],[1553,"HF_MIFARE_READER"],[1554,"HF_MIFARE_NESTED"],[1555,"HF_MIFARE_ACQ_ENCRYPTED_NONCES"],[1556,"HF_MIFARE_ACQ_NONCES"],[1557,"HF_MIFARE_STATIC_NESTED"],[1568,"HF_MIFARE_READBL"],[1824,"HF_MIFAREU_READBL"],[1569,"HF_MIFARE_READSC"],[1825,"HF_MIFAREU_READCARD"],[1570,"HF_MIFARE_WRITEBL"],[1575,"HF_MIFARE_VALUE"],[1826,"HF_MIFAREU_WRITEBL"],[1827,"HF_MIFAREU_WRITEBL_COMPAT"],[1571,"HF_MIFARE_CHKKEYS"],[1572,"HF_MIFARE_SETMOD"],[1573,"HF_MIFARE_CHKKEYS_FAST"],[1574,"HF_MIFARE_CHKKEYS_FILE"],[1584,"HF_MIFARE_SNIFF"],[1585,"HF_MIFARE_MFKEY"],[1586,"HF_MIFARE_PERSONALIZE_UID"],[1828,"HF_MIFAREUC_AUTH"],[1831,"HF_MIFAREUC_SETPWD"],[1832,"HF_DESFIRE_READBL"],[1833,"HF_DESFIRE_WRITEBL"],[1834,"HF_DESFIRE_AUTH1"],[1835,"HF_DESFIRE_AUTH2"],[1836,"HF_DESFIRE_READER"],[1837,"HF_DESFIRE_INFO"],[1838,"HF_DESFIRE_COMMAND"],[1840,"HF_MIFARE_NACK_DETECT"],[1841,"HF_MIFARE_STATIC_NONCE"],[1856,"HF_MFU_OTP_TEAROFF"],[1857,"HF_MFU_COUNTER_TEAROFF"],[2048,"HF_SNIFF"],[2049,"HF_PLOT"],[2050,"FPGAMEM_DOWNLOAD"],[2051,"FPGAMEM_DOWNLOADED"],[2064,"HF_THINFILM_READ"],[2065,"HF_THINFILM_SIMULATE"],[2080,"HF_CRYPTORF_SIM"],[2128,"HF_MIFARE_GEN3UID"],[2129,"HF_MIFARE_GEN3BLK"],[2130,"HF_MIFARE_GEN3FREEZ"],[2144,"HF_MIFARE_G4_RDBL"],[65535,"UNKNOWN"]],(([t,e])=>[e,t])));class A{constructor(t){if(!n.isLen(t))throw new TypeError("invalid pack");this.pack=t,this.data=t.subarray(10+(this.ng?0:24),t.length-2)}get len(){return this.pack.length}get ng(){return(128&this.pack.getUint8(5))>0}get status(){return this.pack.getInt16(6)}get cmd(){return this.pack.getUint16(8)}get crc(){return this.pack.getUint16(this.pack.length-2)}getArg(t){return this.pack.getBigUint64(10+(t<<3))}}class S{constructor(t){if(!n.isLen(t))throw new TypeError("invalid pack");this.pack=t,this.data=t.subarray(32)}get cmd(){return this.pack.getUint16(0)}getArg(t){return this.pack.getBigUint64(8+(t<<3))}}const T=t=>{let e=544;return t.length>=10&&1647529296===t.getUint32(0)&&(e=12+(32767&t.getUint16(4))),[0,t.length>=e?e:0]};t.Packet=n,t.Proxmark3=class{constructor(t){this.middlewares={},this.plugins=new Map,this.respBuf=[],this.rxBuf=new n,this.tx=null,this.rx=new TransformStream({transform:(t,e)=>{for(this.rxBuf=n.merge(this.rxBuf,t);;){const[t,_]=T(this.rxBuf);if(_<1)return;const r=this.rxBuf.slice(t,t+_);e.enqueue(1647529296===r.getUint32(0)?new A(r):new S(r)),this.rxBuf=this.rxBuf.slice(t+_)}}}),this.rx.readable.pipeTo(new WritableStream({write:t=>{this.respBuf.push(t)}}))}async use(t,e={}){if(!t||!r.default.isFunction(t.install)||!r.default.isString(t.name))throw new TypeError("property plugin.name and method plugin.install is required.");const _=`$${t.name}`;if(this.hasPlugin(_))return this;const i=await t.install({Packet:n,pm3:this,PM3_CMD:a,utils:I},e);return r.default.isNil(i)||(this[_]=i),this.addPlugin(_,t),this}addPlugin(t,e){this.plugins.set(t,e)}hasPlugin(t){return this.plugins.has(t)}addMiddleware(t,e){if(!r.default.isString(t)||!t.length)throw new TypeError("key is required");if(!r.default.isFunction(e))throw new TypeError("middleware is required");r.default.isArray(this.middlewares[t])||(this.middlewares[t]=[]),this.middlewares[t].push(e)}async writePacket(t){const e=s([...this.middlewares.writePacket??[],async(t,e)=>{if(!n.isLen(t.pack))throw new TypeError("pack should be Packet");if(t.writer=this.tx?.writable?.getWriter?.(),!t.writer)throw new Error("Failed to getWriter(). Did you remember to use adapter plugin?");await t.writer.write(t.pack),t.writer.releaseLock()}]);return await e({pack:t})}async sendCommandNG({cmd:t,data:e=new n,ng:_=!0}){if(!n.isLen(e))throw new TypeError("data should be Packet");if(e.length>512)throw new TypeError("data.length > 512");const r=new n(e.length+10);r.set(n.fromUtf8("PM3a")),r.setUint16(4,e.length|(_?32768:0)),r.setUint16(6,Number(BigInt.asUintN(16,BigInt(t)))),e.length&&r.set(e,8),r.set(n.fromUtf8("a3"),e.length+8),await this.writePacket(r)}async sendCommandMix({cmd:t,arg:e=[],data:_=new n}){if(!n.isLen(_))throw new TypeError("data should be Packet");if(_.length>488)throw new TypeError("data.length > 488");const r=new n(_.length+24);_.length&&r.set(_,24);for(let t=0;t<3;t++)r.setBigUint64(t<<3,BigInt(e[t]??0));return await this.sendCommandNG({cmd:t,data:r,ng:!1})}async sendCommandOLD({cmd:t,arg:e=[],data:_=new n}){if(!n.isLen(_))throw new TypeError("data should be Packet");if(_.length>512)throw new TypeError("data.length > 512");const r=new n(544);_.length&&r.set(_,32),r.setBigUint64(0,BigInt(t));for(let t=0;t<3;t++)r.setBigUint64(8+(t<<3),BigInt(e[t]??0));await this.writePacket(r)}clearRespBuf(){this.respBuf.splice(0,this.respBuf.length)}async readRespTimeout(t=null,e=5e3){const _=s([...this.middlewares.readRespTimeout??[],async(e,_)=>{for(e.startedAt=Date.now();;){if(e.nowts=Date.now(),e.nowts>e.startedAt+e.timeout)throw new Error(`readRespTimeout ${e.timeout}ms`);for(;this.respBuf.length;){const _=this.respBuf.shift();if(_.cmd!==a.DEBUG_PRINT_STRING)if(_.cmd!==a.WTX||2!==_.data.length){if(t===a.UNKNOWN||_.cmd===e.cmd)return _}else{const t=_.data.getUint16(0);t<65535&&(i(`extend timeout: ${e.timeout} + ${t} = ${e.timeout+t} ms`),e.timeout+=t)}else i(_.data.subarray(2).utf8)}await F(10)}}]);return await _({cmd:t,timeout:e})}},t.utils=I,t.version="0.1.0",Object.defineProperty(t,"__esModule",{value:!0})}));
